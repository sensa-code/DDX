<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç€è¦½å™¨è¨ºæ–·å·¥å…·</title>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  max-width: 1200px;
  margin: 20px auto;
  padding: 20px;
  background: #f5f5f5;
}
.diagnostic-box {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
h1 {
  color: #2c6e49;
  border-bottom: 3px solid #2c6e49;
  padding-bottom: 10px;
}
h2 {
  color: #4c956c;
  margin-top: 0;
}
.status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 4px;
  font-weight: bold;
  margin-left: 10px;
}
.status.ok {
  background: #d4edda;
  color: #155724;
}
.status.error {
  background: #f8d7da;
  color: #721c24;
}
.status.warning {
  background: #fff3cd;
  color: #856404;
}
pre {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 15px;
  overflow-x: auto;
  max-height: 400px;
}
.test-item {
  margin: 10px 0;
  padding: 10px;
  border-left: 4px solid #6c757d;
  background: #f8f9fa;
}
.test-item.pass {
  border-left-color: #28a745;
}
.test-item.fail {
  border-left-color: #dc3545;
}
button {
  background: #2c6e49;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  margin: 5px;
}
button:hover {
  background: #1b4332;
}
#results {
  white-space: pre-wrap;
  font-family: monospace;
}
</style>
</head>
<body>

<h1>ğŸ” å°å‹•ç‰©é‘‘åˆ¥è¨ºæ–·ç³»çµ± - ç€è¦½å™¨è¨ºæ–·å·¥å…·</h1>

<div class="diagnostic-box">
  <h2>è¨ºæ–·æ§åˆ¶</h2>
  <button onclick="runFullDiagnostic()">â–¶ åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
  <button onclick="testRenderSidebar()">ğŸ”„ æ‰‹å‹•åŸ·è¡Œ renderSidebar()</button>
  <button onclick="inspectElements()">ğŸ” æª¢æŸ¥DOMå…ƒç´ </button>
  <button onclick="clearResults()">ğŸ—‘ æ¸…é™¤çµæœ</button>
</div>

<div class="diagnostic-box">
  <h2>è¨ºæ–·çµæœ</h2>
  <div id="results">ç­‰å¾…åŸ·è¡Œè¨ºæ–·...</div>
</div>

<script>
let resultsDiv;

function log(message, type = 'info') {
  const timestamp = new Date().toLocaleTimeString();
  const icon = {
    'ok': 'âœ…',
    'error': 'âŒ',
    'warning': 'âš ï¸',
    'info': 'â„¹ï¸'
  }[type] || 'â„¹ï¸';

  resultsDiv.innerHTML += `[${timestamp}] ${icon} ${message}\n`;
  resultsDiv.scrollTop = resultsDiv.scrollHeight;
}

function clearResults() {
  resultsDiv.innerHTML = '';
  log('è¨ºæ–·çµæœå·²æ¸…é™¤');
}

function runFullDiagnostic() {
  clearResults();
  log('é–‹å§‹å®Œæ•´è¨ºæ–·...', 'info');
  log('='.repeat(60), 'info');

  // 1. æª¢æŸ¥é é¢æ˜¯å¦å·²è¼‰å…¥ä¸»æ‡‰ç”¨
  log('\nç¬¬1æ­¥ï¼šæª¢æŸ¥ä¸»é é¢è¼‰å…¥ç‹€æ…‹', 'info');

  const mainWindow = window.opener || window;

  if (!mainWindow.DB) {
    log('ä¸»é é¢çš„ DB ç‰©ä»¶æœªå®šç¾©', 'error');
    log('è«‹ç¢ºä¿æ‚¨å·²æ‰“é–‹ vet-differential-diagnosis-v2.html', 'error');
    log('\nè¨ºæ–·æ–¹æ³•ï¼š', 'info');
    log('1. åœ¨å¦ä¸€å€‹åˆ†é æ‰“é–‹ vet-differential-diagnosis-v2.html', 'info');
    log('2. æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·', 'info');
    log('3. åœ¨ Console ä¸­è¼¸å…¥ä»¥ä¸‹å‘½ä»¤ï¼š', 'info');
    log('   window.open("browser-diagnostic.html")', 'info');
    return;
  }

  log('ä¸»é é¢å·²è¼‰å…¥', 'ok');

  // 2. æª¢æŸ¥ DB ç‰©ä»¶
  log('\nç¬¬2æ­¥ï¼šæª¢æŸ¥ DB ç‰©ä»¶', 'info');
  try {
    const DB = mainWindow.DB;
    log(`DB ç‰©ä»¶å­˜åœ¨`, 'ok');

    if (DB.symptoms) {
      log(`DB.symptoms å­˜åœ¨ï¼ŒåŒ…å« ${DB.symptoms.length} å€‹ç—‡ç‹€`, 'ok');

      // åˆ—å‡ºå‰10å€‹ç—‡ç‹€
      log('\nå‰10å€‹ç—‡ç‹€:', 'info');
      DB.symptoms.slice(0, 10).forEach((sym, i) => {
        log(`  ${i+1}. ${sym.zhName} (${sym.id})`, 'info');
      });

      // æª¢æŸ¥ç—‡ç‹€çµæ§‹
      const firstSym = DB.symptoms[0];
      const requiredFields = ['id', 'zhName', 'enName', 'section', 'differentials'];
      const missingFields = requiredFields.filter(field => !firstSym[field]);

      if (missingFields.length === 0) {
        log('\nç—‡ç‹€è³‡æ–™çµæ§‹å®Œæ•´', 'ok');
      } else {
        log(`\nç—‡ç‹€è³‡æ–™ç¼ºå°‘æ¬„ä½: ${missingFields.join(', ')}`, 'error');
      }
    } else {
      log('DB.symptoms ä¸å­˜åœ¨', 'error');
    }

    if (DB.sections) {
      const sectionCount = Object.keys(DB.sections).length;
      log(`DB.sections å­˜åœ¨ï¼ŒåŒ…å« ${sectionCount} å€‹åˆ†é¡`, 'ok');

      log('\nåˆ†é¡åˆ—è¡¨:', 'info');
      for (const [key, value] of Object.entries(DB.sections)) {
        log(`  ${key}: ${value.name}`, 'info');
      }
    } else {
      log('DB.sections ä¸å­˜åœ¨', 'error');
    }
  } catch (error) {
    log(`æª¢æŸ¥ DB ç‰©ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
  }

  // 3. æª¢æŸ¥ DOM å…ƒç´ 
  log('\nç¬¬3æ­¥ï¼šæª¢æŸ¥ DOM å…ƒç´ ', 'info');
  try {
    const sidebar = mainWindow.document.getElementById('sidebar');
    if (sidebar) {
      log('sidebar å…ƒç´ å­˜åœ¨', 'ok');

      const computedStyle = mainWindow.getComputedStyle(sidebar);
      log(`  display: ${computedStyle.display}`, 'info');
      log(`  visibility: ${computedStyle.visibility}`, 'info');
      log(`  width: ${sidebar.offsetWidth}px`, 'info');
      log(`  height: ${sidebar.offsetHeight}px`, 'info');
      log(`  innerHTML length: ${sidebar.innerHTML.length} å­—å…ƒ`, 'info');

      if (sidebar.innerHTML.length === 0) {
        log('sidebar å…§å®¹ç‚ºç©ºï¼é€™å°±æ˜¯å•é¡Œæ‰€åœ¨ã€‚', 'error');
      } else if (sidebar.innerHTML.length < 100) {
        log('sidebar å…§å®¹éå°‘ï¼Œå¯èƒ½æ¸²æŸ“å¤±æ•—', 'warning');
        log(`å…§å®¹: ${sidebar.innerHTML.substring(0, 200)}`, 'info');
      } else {
        log('sidebar æœ‰å…§å®¹', 'ok');

        // è¨ˆç®—æŒ‰éˆ•æ•¸é‡
        const buttons = sidebar.querySelectorAll('.symptom-btn');
        log(`  æ‰¾åˆ° ${buttons.length} å€‹ç—‡ç‹€æŒ‰éˆ•`, 'info');

        if (buttons.length === 0) {
          log('æœªæ‰¾åˆ°ç—‡ç‹€æŒ‰éˆ•ï¼æ¸²æŸ“å¯èƒ½å¤±æ•—', 'error');
        }
      }
    } else {
      log('sidebar å…ƒç´ ä¸å­˜åœ¨', 'error');
    }

    const mainContent = mainWindow.document.getElementById('main-content');
    if (mainContent) {
      log('main-content å…ƒç´ å­˜åœ¨', 'ok');
    } else {
      log('main-content å…ƒç´ ä¸å­˜åœ¨', 'error');
    }
  } catch (error) {
    log(`æª¢æŸ¥ DOM å…ƒç´ æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
  }

  // 4. æª¢æŸ¥ç‹€æ…‹
  log('\nç¬¬4æ­¥ï¼šæª¢æŸ¥ state ç‰©ä»¶', 'info');
  try {
    const state = mainWindow.state;
    if (state) {
      log('state ç‰©ä»¶å­˜åœ¨', 'ok');
      log(`  activeSymptom: ${state.activeSymptom}`, 'info');
      log(`  activeTab: ${state.activeTab}`, 'info');
      log(`  speciesFilter: ${state.speciesFilter}`, 'info');

      if (state.collapsedSections) {
        const collapsedCount = Object.values(state.collapsedSections).filter(v => v).length;
        log(`  å·²æ”¶åˆåˆ†é¡: ${collapsedCount}`, 'info');
      }
    } else {
      log('state ç‰©ä»¶ä¸å­˜åœ¨', 'error');
    }
  } catch (error) {
    log(`æª¢æŸ¥ state ç‰©ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
  }

  // 5. æª¢æŸ¥å‡½æ•¸
  log('\nç¬¬5æ­¥ï¼šæª¢æŸ¥é—œéµå‡½æ•¸', 'info');
  try {
    const functions = ['renderSidebar', 'renderWelcome', 'renderSymptomDetail'];
    functions.forEach(funcName => {
      if (typeof mainWindow[funcName] === 'function') {
        log(`${funcName} å‡½æ•¸å­˜åœ¨`, 'ok');
      } else {
        log(`${funcName} å‡½æ•¸ä¸å­˜åœ¨`, 'error');
      }
    });
  } catch (error) {
    log(`æª¢æŸ¥å‡½æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
  }

  // 6. æª¢æŸ¥ConsoleéŒ¯èª¤
  log('\nç¬¬6æ­¥ï¼šæª¢æŸ¥ç€è¦½å™¨Console', 'info');
  log('è«‹æ‰‹å‹•æŸ¥çœ‹ä¸»é é¢çš„é–‹ç™¼è€…å·¥å…· Console æ¨™ç±¤', 'warning');
  log('å°‹æ‰¾ç´…è‰²çš„éŒ¯èª¤è¨Šæ¯', 'warning');

  log('\n' + '='.repeat(60), 'info');
  log('è¨ºæ–·å®Œæˆï¼', 'ok');
  log('\nå»ºè­°ä¸‹ä¸€æ­¥ï¼š', 'info');
  log('1. å¦‚æœ sidebar å…§å®¹ç‚ºç©ºï¼Œå˜—è©¦é»æ“Šã€Œæ‰‹å‹•åŸ·è¡Œ renderSidebar()ã€æŒ‰éˆ•', 'info');
  log('2. æŸ¥çœ‹ä¸»é é¢çš„ Console æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯', 'info');
  log('3. å¦‚æœä»æœ‰å•é¡Œï¼Œè«‹å°‡æ­¤è¨ºæ–·çµæœæˆªåœ–å›å ±', 'info');
}

function testRenderSidebar() {
  clearResults();
  log('å˜—è©¦æ‰‹å‹•åŸ·è¡Œ renderSidebar()...', 'info');

  const mainWindow = window.opener || window;

  if (!mainWindow.renderSidebar) {
    log('renderSidebar å‡½æ•¸ä¸å­˜åœ¨', 'error');
    log('è«‹ç¢ºä¿å·²æ‰“é–‹ä¸»é é¢', 'error');
    return;
  }

  try {
    mainWindow.renderSidebar();
    log('renderSidebar() åŸ·è¡Œå®Œæˆ', 'ok');

    // æª¢æŸ¥çµæœ
    setTimeout(() => {
      const sidebar = mainWindow.document.getElementById('sidebar');
      if (sidebar && sidebar.innerHTML.length > 0) {
        log(`sidebar ç¾åœ¨æœ‰å…§å®¹äº†ï¼é•·åº¦: ${sidebar.innerHTML.length} å­—å…ƒ`, 'ok');
        const buttons = sidebar.querySelectorAll('.symptom-btn');
        log(`æ‰¾åˆ° ${buttons.length} å€‹ç—‡ç‹€æŒ‰éˆ•`, 'ok');
      } else {
        log('sidebar ä»ç„¶æ˜¯ç©ºçš„', 'error');
        log('å¯èƒ½åœ¨æ¸²æŸ“éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    }, 500);
  } catch (error) {
    log(`åŸ·è¡Œ renderSidebar() æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
    log(`éŒ¯èª¤å †ç–Š: ${error.stack}`, 'error');
  }
}

function inspectElements() {
  clearResults();
  log('æª¢æŸ¥DOMå…ƒç´ ç´°ç¯€...', 'info');

  const mainWindow = window.opener || window;
  const sidebar = mainWindow.document.getElementById('sidebar');

  if (!sidebar) {
    log('sidebar å…ƒç´ ä¸å­˜åœ¨', 'error');
    return;
  }

  log('sidebar å…ƒç´ è©³ç´°è³‡è¨Š:', 'info');
  log('='.repeat(60), 'info');

  // åŸºæœ¬è³‡è¨Š
  log(`tagName: ${sidebar.tagName}`, 'info');
  log(`id: ${sidebar.id}`, 'info');
  log(`className: ${sidebar.className}`, 'info');

  // å°ºå¯¸å’Œä½ç½®
  const rect = sidebar.getBoundingClientRect();
  log(`\nä½ç½®å’Œå°ºå¯¸:`, 'info');
  log(`  top: ${rect.top}`, 'info');
  log(`  left: ${rect.left}`, 'info');
  log(`  width: ${rect.width}`, 'info');
  log(`  height: ${rect.height}`, 'info');
  log(`  offsetWidth: ${sidebar.offsetWidth}`, 'info');
  log(`  offsetHeight: ${sidebar.offsetHeight}`, 'info');

  // è¨ˆç®—æ¨£å¼
  const style = mainWindow.getComputedStyle(sidebar);
  log(`\nè¨ˆç®—æ¨£å¼:`, 'info');
  log(`  display: ${style.display}`, 'info');
  log(`  visibility: ${style.visibility}`, 'info');
  log(`  opacity: ${style.opacity}`, 'info');
  log(`  position: ${style.position}`, 'info');
  log(`  z-index: ${style.zIndex}`, 'info');
  log(`  overflow-y: ${style.overflowY}`, 'info');
  log(`  background: ${style.background}`, 'info');

  // å…§å®¹
  log(`\ninnerHTML é•·åº¦: ${sidebar.innerHTML.length}`, 'info');
  if (sidebar.innerHTML.length > 0) {
    log(`å‰500å­—å…ƒ:`, 'info');
    log(sidebar.innerHTML.substring(0, 500), 'info');
  } else {
    log('innerHTML ç‚ºç©ºï¼', 'error');
  }

  // å­å…ƒç´ 
  log(`\nå­å…ƒç´ æ•¸é‡: ${sidebar.children.length}`, 'info');
  if (sidebar.children.length > 0) {
    log('å­å…ƒç´ :', 'info');
    Array.from(sidebar.children).slice(0, 5).forEach((child, i) => {
      log(`  ${i+1}. <${child.tagName}> class="${child.className}"`, 'info');
    });
  }

  // ç—‡ç‹€æŒ‰éˆ•
  const buttons = sidebar.querySelectorAll('.symptom-btn');
  log(`\nç—‡ç‹€æŒ‰éˆ•æ•¸é‡: ${buttons.length}`, buttons.length > 0 ? 'ok' : 'error');

  // Section
  const sections = sidebar.querySelectorAll('.sidebar-section');
  log(`Section æ•¸é‡: ${sections.length}`, sections.length > 0 ? 'ok' : 'error');
}

// åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', () => {
  resultsDiv = document.getElementById('results');
  log('è¨ºæ–·å·¥å…·å·²å°±ç·’', 'ok');
  log('è«‹é»æ“Šã€ŒåŸ·è¡Œå®Œæ•´è¨ºæ–·ã€æŒ‰éˆ•é–‹å§‹', 'info');
  log('\nå¦‚æœæ­¤å·¥å…·èˆ‡ä¸»é é¢åœ¨ä¸åŒè¦–çª—ï¼Œè¨ºæ–·å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œ', 'warning');
  log('å»ºè­°å¾ä¸»é é¢çš„ConsoleåŸ·è¡Œ: window.open("browser-diagnostic.html")', 'info');
});

// æª¢æŸ¥æ˜¯å¦å¾ä¸»é é¢æ‰“é–‹
setTimeout(() => {
  if (!window.opener && !window.DB) {
    log('\nâš ï¸ è­¦å‘Šï¼šæ­¤è¨ºæ–·å·¥å…·ä¼¼ä¹ä¸æ˜¯å¾ä¸»é é¢æ‰“é–‹çš„', 'warning');
    log('ç‚ºäº†æœ€ä½³è¨ºæ–·æ•ˆæœï¼Œè«‹ï¼š', 'info');
    log('1. æ‰“é–‹ vet-differential-diagnosis-v2.html', 'info');
    log('2. æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·', 'info');
    log('3. åœ¨ Console è¼¸å…¥: window.open("browser-diagnostic.html")', 'info');
  }
}, 1000);
</script>

</body>
</html>
