<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ç¸é†«è¨ºæ–·ç³»çµ±è³‡æ–™é©—è­‰å™¨</title>
<style>
body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f5f5f5; }
.container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
h1 { color: #2c6e49; border-bottom: 3px solid #4c956c; padding-bottom: 10px; }
h2 { color: #4c956c; margin-top: 30px; }
.status { padding: 15px; margin: 15px 0; border-radius: 5px; }
.success { background: #d4edda; border-left: 4px solid #28a745; }
.error { background: #f8d7da; border-left: 4px solid #dc3545; }
.warning { background: #fff3cd; border-left: 4px solid #ffc107; }
.info { background: #d1ecf1; border-left: 4px solid #17a2b8; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; }
th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
th { background: #4c956c; color: white; }
.count { font-weight: bold; color: #2c6e49; font-size: 1.2em; }
code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
.progress { margin: 20px 0; }
.progress-bar { width: 100%; height: 30px; background: #e9ecef; border-radius: 5px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #4c956c, #2c6e49); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
.disease-list { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
.disease-item { padding: 5px; margin: 3px 0; background: #f8f9fa; border-radius: 3px; }
button { background: #4c956c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
button:hover { background: #2c6e49; }
</style>
</head>
<body>

<div class="container">
<h1>ğŸ¾ ç¸é†«è¨ºæ–·è¼”åŠ©ç³»çµ± v2.0 - è³‡æ–™é©—è­‰å™¨</h1>

<div id="loadingStatus" class="status info">
  <strong>â³ æ­£åœ¨è¼‰å…¥è³‡æ–™...</strong>
</div>

<div id="results" style="display:none;">

  <h2>ğŸ“Š åŸºæœ¬çµ±è¨ˆ</h2>
  <table>
    <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
    <tr><td>ç¸½ç–¾ç—…æ•¸é‡</td><td class="count" id="totalDiseases">-</td></tr>
    <tr><td>è³‡æ–™å®Œæ•´æ€§</td><td class="count" id="completeness">-</td></tr>
    <tr><td>åˆ¥åç¸½æ•¸</td><td class="count" id="totalAliases">-</td></tr>
    <tr><td>åˆ¥åæŒ‡å‘ç–¾ç—…æ•¸</td><td class="count" id="aliasTargets">-</td></tr>
  </table>

  <h2>âœ… è³‡æ–™å®Œæ•´æ€§</h2>
  <div class="progress">
    <div class="progress-bar">
      <div class="progress-fill" id="completenessBar" style="width: 0%">0%</div>
    </div>
  </div>
  <div id="completenessStatus"></div>

  <h2>ğŸ” IDå”¯ä¸€æ€§é©—è­‰</h2>
  <div id="uniquenessStatus"></div>

  <h2>ğŸ”— åˆ¥åå°ç…§è¡¨é©—è­‰</h2>
  <div id="aliasStatus"></div>

  <h2>ğŸ†• æ–°å¢ç–¾ç—…é©—è­‰ï¼ˆ8å€‹ï¼‰</h2>
  <div id="newDiseasesStatus"></div>

  <h2>ğŸ“‹ ç–¾ç—…åˆ—è¡¨ï¼ˆå‰50å€‹ï¼‰</h2>
  <div class="disease-list" id="diseaseList"></div>

  <h2>ğŸ’¾ åŒ¯å‡ºåŠŸèƒ½</h2>
  <button onclick="downloadReport()">ä¸‹è¼‰å®Œæ•´å ±å‘Š (Markdown)</button>
  <button onclick="downloadData()">ä¸‹è¼‰ç–¾ç—…è³‡æ–™ (JSON)</button>
</div>

</div>

<script src="vet-differential-diagnosis-v2.html"></script>

<script>
// ç­‰å¾…è³‡æ–™è¼‰å…¥
setTimeout(function() {
  try {
    // æª¢æŸ¥è³‡æ–™æ˜¯å¦å­˜åœ¨
    if (typeof DISEASE_INFO === 'undefined' || typeof DISEASE_ALIASES === 'undefined') {
      document.getElementById('loadingStatus').innerHTML = '<strong>âŒ éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ç–¾ç—…è³‡æ–™</strong><p>è«‹ç¢ºèª DISEASE_INFO å’Œ DISEASE_ALIASES å·²æ­£ç¢ºå®šç¾©ã€‚</p>';
      document.getElementById('loadingStatus').className = 'status error';
      throw new Error('è³‡æ–™æœªå®šç¾©');
    }

    document.getElementById('loadingStatus').innerHTML = '<strong>âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼</strong>';
    document.getElementById('loadingStatus').className = 'status success';
    document.getElementById('results').style.display = 'block';

    // é–‹å§‹é©—è­‰
    validateData();

  } catch (error) {
    document.getElementById('loadingStatus').innerHTML = '<strong>âŒ è¼‰å…¥å¤±æ•—</strong><p>' + error.message + '</p>';
    document.getElementById('loadingStatus').className = 'status error';
  }
}, 1000);

function validateData() {
  const diseaseIds = Object.keys(DISEASE_INFO);
  const aliases = Object.keys(DISEASE_ALIASES);

  // 1. åŸºæœ¬çµ±è¨ˆ
  document.getElementById('totalDiseases').textContent = diseaseIds.length;
  document.getElementById('totalAliases').textContent = aliases.length;

  // 2. è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥
  const requiredFields = ['zh', 'en', 'definition'];
  let completeCount = 0;
  const missingFields = [];

  diseaseIds.forEach(id => {
    const disease = DISEASE_INFO[id];
    const missing = [];

    requiredFields.forEach(field => {
      if (!disease[field] || disease[field] === '') {
        missing.push(field);
      }
    });

    if (missing.length === 0) {
      completeCount++;
    } else {
      missingFields.push({ id, missing });
    }
  });

  const completenessPercent = (completeCount / diseaseIds.length * 100).toFixed(2);
  document.getElementById('completeness').textContent = completenessPercent + '%';
  document.getElementById('completenessBar').style.width = completenessPercent + '%';
  document.getElementById('completenessBar').textContent = completenessPercent + '%';

  if (missingFields.length === 0) {
    document.getElementById('completenessStatus').innerHTML = '<div class="status success"><strong>âœ… æ‰€æœ‰ç–¾ç—…è³‡æ–™å®Œæ•´</strong></div>';
  } else {
    let html = '<div class="status warning"><strong>âš ï¸ ' + missingFields.length + ' å€‹ç–¾ç—…è³‡æ–™ä¸å®Œæ•´</strong><br>';
    html += '<p>ç¼ºå°‘æ¬„ä½çš„ç–¾ç—…ï¼ˆå‰10å€‹ï¼‰ï¼š</p><ul>';
    missingFields.slice(0, 10).forEach(item => {
      html += '<li><code>' + item.id + '</code>: ç¼ºå°‘ ' + item.missing.join(', ') + '</li>';
    });
    html += '</ul></div>';
    document.getElementById('completenessStatus').innerHTML = html;
  }

  // 3. IDå”¯ä¸€æ€§
  const idSet = new Set();
  const duplicates = [];
  diseaseIds.forEach(id => {
    if (idSet.has(id)) {
      duplicates.push(id);
    }
    idSet.add(id);
  });

  if (duplicates.length === 0) {
    document.getElementById('uniquenessStatus').innerHTML = '<div class="status success"><strong>âœ… æ‰€æœ‰ç–¾ç—…IDå”¯ä¸€</strong></div>';
  } else {
    let html = '<div class="status error"><strong>âŒ ç™¼ç¾ ' + duplicates.length + ' å€‹é‡è¤‡ID</strong><ul>';
    duplicates.forEach(id => {
      html += '<li><code>' + id + '</code></li>';
    });
    html += '</ul></div>';
    document.getElementById('uniquenessStatus').innerHTML = html;
  }

  // 4. åˆ¥åé©—è­‰
  const orphanedAliases = [];
  const uniqueTargets = new Set();

  aliases.forEach(alias => {
    const target = DISEASE_ALIASES[alias];
    uniqueTargets.add(target);

    if (!DISEASE_INFO[target]) {
      orphanedAliases.push({ alias, target });
    }
  });

  document.getElementById('aliasTargets').textContent = uniqueTargets.size;

  if (orphanedAliases.length === 0) {
    document.getElementById('aliasStatus').innerHTML = '<div class="status success"><strong>âœ… æ‰€æœ‰åˆ¥åéƒ½æŒ‡å‘æœ‰æ•ˆçš„ç–¾ç—…ID</strong></div>';
  } else {
    let html = '<div class="status error"><strong>âŒ ç™¼ç¾ ' + orphanedAliases.length + ' å€‹å­¤ç«‹åˆ¥å</strong><br>';
    html += '<p>æŒ‡å‘ä¸å­˜åœ¨ç–¾ç—…çš„åˆ¥åï¼ˆå‰10å€‹ï¼‰ï¼š</p><ul>';
    orphanedAliases.slice(0, 10).forEach(item => {
      html += '<li>"' + item.alias + '" â†’ <code>' + item.target + '</code> (ä¸å­˜åœ¨)</li>';
    });
    html += '</ul></div>';
    document.getElementById('aliasStatus').innerHTML = html;
  }

  // 5. æ–°å¢ç–¾ç—…é©—è­‰
  const newDiseases = [
    '5-fluorouracil-toxicosis',
    'abdominal-compartment-syndrome',
    'abortion-dog',
    'cachexia-cardiac',
    'hypospadias',
    'herpesvirus-dog',
    'helicobacter-gastritis',
    'neonatal-isoerythrolysis'
  ];

  let newDiseaseHtml = '<table><tr><th>ç–¾ç—…ID</th><th>å­˜åœ¨</th><th>åˆ¥å</th><th>ä¸­æ–‡</th><th>å®šç¾©</th></tr>';
  newDiseases.forEach(id => {
    const exists = DISEASE_INFO.hasOwnProperty(id);
    const hasAlias = Object.values(DISEASE_ALIASES).includes(id);
    const disease = DISEASE_INFO[id];

    newDiseaseHtml += '<tr>';
    newDiseaseHtml += '<td><code>' + id + '</code></td>';
    newDiseaseHtml += '<td>' + (exists ? 'âœ…' : 'âŒ') + '</td>';
    newDiseaseHtml += '<td>' + (hasAlias ? 'âœ…' : 'âŒ') + '</td>';
    newDiseaseHtml += '<td>' + (exists && disease.zh ? disease.zh : 'âŒ') + '</td>';
    newDiseaseHtml += '<td>' + (exists && disease.definition ? 'âœ…' : 'âŒ') + '</td>';
    newDiseaseHtml += '</tr>';
  });
  newDiseaseHtml += '</table>';
  document.getElementById('newDiseasesStatus').innerHTML = newDiseaseHtml;

  // 6. ç–¾ç—…åˆ—è¡¨
  let listHtml = '';
  diseaseIds.slice(0, 50).forEach((id, index) => {
    const disease = DISEASE_INFO[id];
    listHtml += '<div class="disease-item">';
    listHtml += '<strong>' + (index + 1) + '.</strong> ';
    listHtml += '<code>' + id + '</code> - ';
    listHtml += disease.zh || '(ç„¡ä¸­æ–‡)';
    listHtml += ' / ' + (disease.en || '(ç„¡è‹±æ–‡)');
    listHtml += '</div>';
  });
  if (diseaseIds.length > 50) {
    listHtml += '<div class="status info">... ä»¥åŠå…¶ä»– ' + (diseaseIds.length - 50) + ' å€‹ç–¾ç—…</div>';
  }
  document.getElementById('diseaseList').innerHTML = listHtml;

  // å„²å­˜å…¨åŸŸè®Šæ•¸ä¾›ä¸‹è¼‰ä½¿ç”¨
  window.validationResults = {
    diseaseIds,
    aliases,
    completeCount,
    missingFields,
    duplicates,
    orphanedAliases,
    uniqueTargets,
    newDiseases
  };
}

function downloadReport() {
  const results = window.validationResults;
  const timestamp = new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });

  let content = '# ç¸é†«è¨ºæ–·è¼”åŠ©ç³»çµ±é©—è­‰å ±å‘Š\n\n';
  content += '**é©—è­‰æ—¥æœŸ**: ' + timestamp + '\n';
  content += '**ç³»çµ±ç‰ˆæœ¬**: v2.0\n\n';
  content += '---\n\n';

  content += '## åŸºæœ¬çµ±è¨ˆ\n\n';
  content += '| é …ç›® | æ•¸é‡ |\n';
  content += '|------|------|\n';
  content += '| ç¸½ç–¾ç—…æ•¸é‡ | ' + results.diseaseIds.length + ' |\n';
  content += '| å®Œæ•´è³‡æ–™ç–¾ç—… | ' + results.completeCount + ' |\n';
  content += '| è³‡æ–™å®Œæ•´æ€§ | ' + (results.completeCount / results.diseaseIds.length * 100).toFixed(2) + '% |\n';
  content += '| åˆ¥åç¸½æ•¸ | ' + results.aliases.length + ' |\n';
  content += '| åˆ¥åæŒ‡å‘ç–¾ç—…æ•¸ | ' + results.uniqueTargets.size + ' |\n\n';

  content += '## é©—è­‰çµæœ\n\n';
  content += '- **IDå”¯ä¸€æ€§**: ' + (results.duplicates.length === 0 ? 'âœ… é€šé' : 'âŒ å¤±æ•—') + '\n';
  content += '- **åˆ¥åæœ‰æ•ˆæ€§**: ' + (results.orphanedAliases.length === 0 ? 'âœ… é€šé' : 'âŒ ' + results.orphanedAliases.length + ' å€‹å•é¡Œ') + '\n';
  content += '- **è³‡æ–™å®Œæ•´æ€§**: ' + (results.missingFields.length === 0 ? 'âœ… å®Œç¾' : 'âš ï¸ ' + results.missingFields.length + ' å€‹éœ€è£œå……') + '\n\n';

  if (results.missingFields.length > 0) {
    content += '## ä¸å®Œæ•´è³‡æ–™\n\n';
    results.missingFields.slice(0, 20).forEach(item => {
      content += '- `' + item.id + '`: ç¼ºå°‘ ' + item.missing.join(', ') + '\n';
    });
    content += '\n';
  }

  const blob = new Blob([content], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'validation-report-' + Date.now() + '.md';
  a.click();
}

function downloadData() {
  const data = {
    diseases: DISEASE_INFO,
    aliases: DISEASE_ALIASES,
    metadata: {
      totalDiseases: Object.keys(DISEASE_INFO).length,
      totalAliases: Object.keys(DISEASE_ALIASES).length,
      exportDate: new Date().toISOString(),
      version: '2.0'
    }
  };

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'disease-data-' + Date.now() + '.json';
  a.click();
}
</script>

</body>
</html>
